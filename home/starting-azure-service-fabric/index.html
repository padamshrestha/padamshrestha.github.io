<!DOCTYPE html>
<html class="no-js" lang="en"> <head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="Notes from day to day tasks" name="description"/><meta content="Padam Shrestha" name="author"/><link href="../../assets/images/favicon.png" rel="icon"/><meta content="mkdocs-1.5.3, mkdocs-material-8.5.7" name="generator"/><title>Starting Azure Service Fabric - Blog</title><link href="../../assets/stylesheets/main.20d9efc8.min.css" rel="stylesheet"/><link href="../../assets/stylesheets/palette.cbb835fc.min.css" rel="stylesheet"/><link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link href="../../assets/stylesheets/extra.css" rel="stylesheet"/><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-08DR4DTC9K"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-08DR4DTC9K",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-08DR4DTC9K",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
            html.glightbox-open { overflow: initial; height: 100%; }
            .gdesc-inner { font-size: 0.75rem; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            
                .gscrollbar-fixer { padding-right: 15px; }
                </style><script src="../../assets/javascripts/glightbox.min.js"></script></head> <body data-md-color-accent="indigo" data-md-color-primary="light-blue" data-md-color-scheme="slate" dir="ltr"> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/> <input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/> <label class="md-overlay" for="__drawer"></label> <div data-md-component="skip"> <a class="md-skip" href="#starting-azure-service-fabric"> Skip to content </a> </div> <div data-md-component="announce"> </div> <header class="md-header" data-md-component="header"> <nav aria-label="Header" class="md-header__inner md-grid"> <a aria-label="Blog" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Blog"> <img alt="logo" src="../../assets/images/blog_logo.png"/> </a> <label class="md-header__button md-icon" for="__drawer"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg> </label> <div class="md-header__title" data-md-component="header-title"> <div class="md-header__ellipsis"> <div class="md-header__topic"> <span class="md-ellipsis"> Blog </span> </div> <div class="md-header__topic" data-md-component="header-topic"> <span class="md-ellipsis"> Starting Azure Service Fabric </span> </div> </div> </div> <form class="md-header__option" data-md-component="palette"> <input aria-label="Switch to light mode" class="md-option" data-md-color-accent="indigo" data-md-color-media="" data-md-color-primary="light-blue" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to light mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"></path></svg> </label> <input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="red" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_2" name="__palette" type="radio"/> <label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"></path></svg> </label> </form> <label class="md-header__button md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> </label> <div class="md-search" data-md-component="search" role="dialog"> <label class="md-search__overlay" for="__search"></label> <div class="md-search__inner" role="search"> <form class="md-search__form" name="search"> <input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/> <label class="md-search__icon md-icon" for="__search"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </label> <nav aria-label="Search" class="md-search__options"> <button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg> </button> </nav> <div class="md-search__suggest" data-md-component="search-suggest"></div> </form> <div class="md-search__output"> <div class="md-search__scrollwrap" data-md-scrollfix=""> <div class="md-search-result" data-md-component="search-result"> <div class="md-search-result__meta"> Initializing search </div> <ol class="md-search-result__list"></ol> </div> </div> </div> </div> </div> </nav> </header> <div class="md-container" data-md-component="container"> <main class="md-main" data-md-component="main"> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0"> <label class="md-nav__title" for="__drawer"> <a aria-label="Blog" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Blog"> <img alt="logo" src="../../assets/images/blog_logo.png"/> </a> Blog </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../.."> Home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/> <label class="md-nav__link" for="__nav_2"> Synapse <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Synapse" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_2"> <span class="md-nav__icon md-icon"></span> Synapse </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/build-dev-pyspark-cluster/"> üê≥ Build Development Spark cluster - PySpark, Delta Lake </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/pyspark-dataframe-api/"> üìù PySpark Quickstart </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/pyspark-cheat-sheet/"> üìÑ PySpark Cheat Sheet </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/pyspark-azure-tables/"> ‚ú® Creating tables in PySpark Azure </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../explore/spark-delta-partition/"> Creating partition in delta lake with spark </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../explore/generate-stock-schema-delta-api/"> Design stock and option schema and provide fast api to access using spark delta </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/introduction/"> üìò Synapse Introduction </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/problem-solutions/"> üîì Synapse / PySpark problem and solutions </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../explore/data-dcitionary-pipeline/"> üß∫ Data dictionary for metadata driven Synapse pipeline </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/pyspark-courses/"> üîÖ Courses and Tutorials </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../synapse/links/"> üîó Synapse links </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" id="__nav_3" type="checkbox"/> <label class="md-nav__link" for="__nav_3"> Python <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Python" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_3"> <span class="md-nav__icon md-icon"></span> Python </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../python/python-basics/"> üêç Python Basics </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../python/create-python-package/"> üì¶ Create Custom Python Package </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../python/python-courses/"> üìô Courses and Tutorials </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../python/links/"> üîó Python links </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/> <label class="md-nav__link" for="__nav_4"> Dotnet <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Dotnet" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_4"> <span class="md-nav__icon md-icon"></span> Dotnet </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../csharp/csharp-7/"> What's new in C# 7.0 through C# 7.3 </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../csharp/csharp-8/"> What's new in C# 8.0 </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../csharp/csharp-9/"> What's new in C# 9.0 - C# Guide </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../csharp/csharp-10/"> What's new in C# 10 - C# Guide </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../csharp/csharp-11/"> What's new in C# 11 - C# Guide </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" id="__nav_5" type="checkbox"/> <label class="md-nav__link" for="__nav_5"> Microservices <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Microservices" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_5"> <span class="md-nav__icon md-icon"></span> Microservices </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../microservices/grafana-dashboards/"> Grafana Dashboards </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../microservices/azure-function-dapr/"> Azure function with Dapr to create event-driven, distributed application </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../microservices/dapr-resources/"> Resources </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../microservices/links/"> üîó Dapr links </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" id="__nav_6" type="checkbox"/> <label class="md-nav__link" for="__nav_6"> Serverless <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Serverless" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_6"> <span class="md-nav__icon md-icon"></span> Serverless </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../serverless/links/"> üîó Azure Serverless links </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" id="__nav_7" type="checkbox"/> <label class="md-nav__link" for="__nav_7"> Azure <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Azure" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_7"> <span class="md-nav__icon md-icon"></span> Azure </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../azure-resource-graph-explorer/"> Write query using Azure Resource Graph Explorer </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../azure-keyboard-shortcuts/"> Azure Keyboard Shortcuts in Azure Portal </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../azure-service-fabric/"> Introduction to Azure Service Fabric </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/> <label class="md-nav__link md-nav__link--active" for="__toc"> Starting Azure Service Fabric <span class="md-nav__icon md-icon"></span> </label> <a class="md-nav__link md-nav__link--active" href="./"> Starting Azure Service Fabric </a> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#options-for-building-microservices-in-azure"> Options for building Microservices in Azure: </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#programming-models-provided-by-service-fabric"> Programming Models provided by Service Fabric </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#installing-service-fabric"> Installing Service Fabric </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-service-fabric-services"> Creating Service Fabric Services </a> <nav aria-label="Creating Service Fabric Services" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#service-fabric-state"> Service Fabric State </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-service-application"> Creating Service Application </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#service-lifecycle"> Service Lifecycle </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-product-catalog-service"> Creating Product Catalog Service </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-a-web-api"> Creating a Web API </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#communicating-between-two-services"> Communicating between two services </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#end-to-end-flow"> End to End flow </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#exploring-actor-model-support"> Exploring Actor Model Support </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#managing-state"> Managing State </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#getting-ready-for-deployment"> Getting Ready for Deployment </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#test"> Test </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../azure/links/"> üîó Azure links </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" id="__nav_8" type="checkbox"/> <label class="md-nav__link" for="__nav_8"> Spark <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Spark" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_8"> <span class="md-nav__icon md-icon"></span> Spark </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/jupyter-pyspark-docker/"> Run Jupyter for Pyspark on Docker </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/dotnet-spark-learning/"> Spark Machine Learning </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/dotnet-spark-docker/"> Run and Debug Dotnet Spark application on Docker </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/dotnet-spark-ubuntu/"> Install Dotnet Spark on Ubuntu </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/dotnet-spark-docker-ubuntu/"> Running Dotnet Spark applications on Ubuntu Continer </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/install-docker-ubuntu2004/"> Install Docker on Ubuntu 20.04 LTS and Dotnet Spark on Docker </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/python-learning/"> Learning Python </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../spark/links/"> üîó Spark links </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" id="__nav_9" type="checkbox"/> <label class="md-nav__link" for="__nav_9"> Kusto <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Kusto" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_9"> <span class="md-nav__icon md-icon"></span> Kusto </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../kusto-overview/"> Kusto Query Language (KQL) </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../dynamic-365-hcm-kusto/"> Troubleshoot using Kusto </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" id="__nav_10" type="checkbox"/> <label class="md-nav__link" for="__nav_10"> Angular <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Angular" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_10"> <span class="md-nav__icon md-icon"></span> Angular </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../deploy-angular-app-to-github-io-pages/"> Deploy Angular app to github.io pages </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" id="__nav_11" type="checkbox"/> <label class="md-nav__link" for="__nav_11"> Tools and Tricks <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Tools and Tricks" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_11"> <span class="md-nav__icon md-icon"></span> Tools and Tricks </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../explore/fastapi-uvicorn/"> Configure Fast API with Uvicorn in Dockerfile </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/limited_access_pat_token/"> Create Git PAT token with limited access. </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/multiple-remote-git/"> Multiple remote git configuration for repository </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/chocolatey/"> Install and manage applications using Chocolatey </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/keyboard-shortcuts/"> Keyboard shortcuts for everyday tasks </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/error-solutions/"> Everyday error and fixes </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/certificates/"> Searching and Installing Certificates </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/install-vscode-ubuntu/"> Install VS Code on Ubuntu </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/install-brave-ubuntu2004/"> Install Brave browser on Ubuntu 20.04 LTS </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/useful-online-tools/"> ‚öí Useful online tools </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/helpful-links/"> üîó Helpful links </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/nuget/"> Nuget Package Manger </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/docker/"> üê≥ Installing and Running Docker in WSL with VS Code </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/dotnetcore-azurefunction-wsl/"> Install dotnet core 3.1 and azure-functions-core-tools on WSL </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/configure-publish-mkdocs-github/"> üìö Configure Mkdocs and Auto deploy to Github.io </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/rename-dotnet-3-6/"> Migrate Dotnet Core 3.1 to DotNet 6.0 </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/git-help/"> Git </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/install-dotnet-sdk-armx64/"> Install dotnet skd on Mac m1 armx64 </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/windows-tricks/"> Windows tricks </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tools/linux-commands/"> Useful linux commands </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" id="__nav_12" type="checkbox"/> <label class="md-nav__link" for="__nav_12"> Courses, Projects, Tutorials, Blogs <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Courses, Projects, Tutorials, Blogs" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_12"> <span class="md-nav__icon md-icon"></span> Courses, Projects, Tutorials, Blogs </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../courses-projects/coursera/"> Coursera Courses </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../courses-projects/github_project/"> Github repo and projects </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" id="__nav_13" type="checkbox"/> <label class="md-nav__link" for="__nav_13"> Finance <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Finance" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_13"> <span class="md-nav__icon md-icon"></span> Finance </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../finance/use_of_ft/"> Fourier Transform in Price </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" id="__nav_14" type="checkbox"/> <label class="md-nav__link" for="__nav_14"> Random <span class="md-nav__icon md-icon"></span> </label> <nav aria-label="Random" class="md-nav" data-md-level="1"> <label class="md-nav__title" for="__nav_14"> <span class="md-nav__icon md-icon"></span> Random </label> <ul class="md-nav__list" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="../../random/links/"> üîó Random useful links </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="../../tags/"> Tags </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc"> <div class="md-sidebar__scrollwrap"> <div class="md-sidebar__inner"> <nav aria-label="Table of contents" class="md-nav md-nav--secondary"> <label class="md-nav__title" for="__toc"> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix=""> <li class="md-nav__item"> <a class="md-nav__link" href="#options-for-building-microservices-in-azure"> Options for building Microservices in Azure: </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#programming-models-provided-by-service-fabric"> Programming Models provided by Service Fabric </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#installing-service-fabric"> Installing Service Fabric </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-service-fabric-services"> Creating Service Fabric Services </a> <nav aria-label="Creating Service Fabric Services" class="md-nav"> <ul class="md-nav__list"> <li class="md-nav__item"> <a class="md-nav__link" href="#service-fabric-state"> Service Fabric State </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-service-application"> Creating Service Application </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#service-lifecycle"> Service Lifecycle </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-product-catalog-service"> Creating Product Catalog Service </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#creating-a-web-api"> Creating a Web API </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#communicating-between-two-services"> Communicating between two services </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#end-to-end-flow"> End to End flow </a> </li> </ul> </nav> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#exploring-actor-model-support"> Exploring Actor Model Support </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#managing-state"> Managing State </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#getting-ready-for-deployment"> Getting Ready for Deployment </a> </li> <li class="md-nav__item"> <a class="md-nav__link" href="#test"> Test </a> </li> </ul> </nav> </div> </div> </div> <div class="md-content" data-md-component="content"> <article class="md-content__inner md-typeset"> <h1 id="starting-azure-service-fabric">Starting Azure Service Fabric <img alt="‚òÅ" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/2601.svg" title=":cloud:"/><a class="headerlink" href="#starting-azure-service-fabric" title="Permanent link">¬∂</a></h1> <h2 id="options-for-building-microservices-in-azure">Options for building Microservices in Azure:<a class="headerlink" href="#options-for-building-microservices-in-azure" title="Permanent link">¬∂</a></h2> <ul> <li>Azure Kubernetes Service - Container Orchestrator</li> <li>Azure Service Fabric - Microservice framework and orchestrator that solves many of problems</li> <li>Service Communication</li> <li>Service discovery</li> <li>Telemetry</li> <li>Provision and upgrade</li> <li>Testing locally</li> <li>Manage downtimes</li> <li>Scaling in and out</li> <li>Azure Functions</li> </ul> <h2 id="programming-models-provided-by-service-fabric">Programming Models provided by Service Fabric<a class="headerlink" href="#programming-models-provided-by-service-fabric" title="Permanent link">¬∂</a></h2> <ul> <li>Reliable services</li> <li>stateless (similar to console app)</li> <li>stateful</li> <li>Reliable actors - Virtual actor design pattern built on top of stateful reliable services framework to handle massive amount of client request with enormous computing power</li> <li>Guest executables - Wrap any existing application to run on Service Fabric</li> <li>Containers</li> </ul> <h2 id="installing-service-fabric">Installing Service Fabric<a class="headerlink" href="#installing-service-fabric" title="Permanent link">¬∂</a></h2> <p>Service Fabric is best in cloud environment but can be installed in On Premise as well as in Developer workstation and the is no difference the underlying Service Fabric.</p> <p><strong>OneBox</strong> - Azure Service Fabric Cluster that can be deployed to a single dev machine.</p> <div class="admonition tip"> <p class="admonition-title">Tip</p> <div class="highlight"><span class="filename">Text Only</span><pre><span></span><code>Tools:
```markdown
* Visual Studio 2019 (Community Version would work as well)
* Service Fabric tooling (it's a part of Visual studio components)
* Service Fabric SDK (can be installed as isolated package or use Web Platform Installer)
```
</code></pre></div> </div> <h2 id="creating-service-fabric-services">Creating Service Fabric Services<a class="headerlink" href="#creating-service-fabric-services" title="Permanent link">¬∂</a></h2> <h3 id="service-fabric-state"><strong>Service Fabric State</strong><a class="headerlink" href="#service-fabric-state" title="Permanent link">¬∂</a></h3> <p>The minimum set of replica to achieve data consistency is called quorum. The size is usually 3 nodes. Service state consist of local storage to save persist state therefore is very fast. <pre class="mermaid"><code>graph LR
    w(write) -.-&gt; a(Service - primary)
    w(write) -.-&gt; b(Replica 1)
    w(write) -.-&gt; c(Replica 2) 
    subgraph quorum
        a(Service - primary) &amp; b(Replica 1) &amp; c(Replica 2) 
    end</code></pre></p> <p>Let's create application with these services We will create services * Web Server (API) - It's a stateless service and only act as a facade. * Product Catalog - It's a stateful service. </p> <pre class="mermaid"><code>graph LR
a(Web Server API) --&gt; b(Product Catalog Service) &amp; c(Checkout Service)--&gt; d(User Service Actors)</code></pre> <p>Both of these services are reliable services as they runs in the background. Reliable service has access to ASF API which is all about microservies, scaling, health report and many more. It has various communication model as http, ftp, websocket etc. It's all about low latency and high speed. It also has access to reliable storage. All these features comes with simple programming model.</p> <h3 id="creating-service-application">Creating Service Application<a class="headerlink" href="#creating-service-application" title="Permanent link">¬∂</a></h3> <p>When we create a new service </p> <p><div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Diagnostics</span><span class="p">;</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading</span><span class="p">;</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Runtime</span><span class="p">;</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">{</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="k">internal</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Program</span>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="c1">/// This is the entry point of the service host process.</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Main</span><span class="p">()</span>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">            </span><span class="k">try</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">                </span><span class="c1">// The ServiceManifest.XML file defines one or more service type names.</span>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">                </span><span class="c1">// Registering a service maps a service type name to a .NET type.</span>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">                </span><span class="c1">// When Service Fabric creates an instance of this service type,</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">                </span><span class="c1">// an instance of the class is created in this host process.</span>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">                </span><span class="n">ServiceRuntime</span><span class="p">.</span><span class="n">RegisterServiceAsync</span><span class="p">(</span><span class="s">"ECommerce.ProductCatalogType"</span><span class="p">,</span>
<a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">                    </span><span class="n">context</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProductCatalog</span><span class="p">(</span><span class="n">context</span><span class="p">)).</span><span class="n">GetAwaiter</span><span class="p">().</span><span class="n">GetResult</span><span class="p">();</span>
<a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>
<a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">                </span><span class="n">ServiceEventSource</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">ServiceTypeRegistered</span><span class="p">(</span><span class="n">Process</span><span class="p">.</span><span class="n">GetCurrentProcess</span><span class="p">().</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="k">typeof</span><span class="p">(</span><span class="n">ProductCatalog</span><span class="p">).</span><span class="n">Name</span><span class="p">);</span>
<a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>
<a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">                </span><span class="c1">// Prevents this host process from terminating so services keep running.</span>
<a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">                </span><span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">Timeout</span><span class="p">.</span><span class="n">Infinite</span><span class="p">);</span>
<a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">            </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">                </span><span class="n">ServiceEventSource</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">ServiceHostInitializationFailed</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>
<a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">                </span><span class="k">throw</span><span class="p">;</span>
<a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="p">}</span>
</code></pre></div> Let's checkout what happens in the code <pre class="mermaid"><code>graph TB
a(Register the Reliable Service) --&gt; b(Log Reliable Service has started) --&gt; c(Sleep forever)</code></pre></p> <p>There is another class get create which ASF creates the instance during run time and this is the entry point for the service. <strong>ProductCatalog.cs</strong> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Fabric</span><span class="p">;</span>
<a href="#__codelineno-2-4" id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a href="#__codelineno-2-5" id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading</span><span class="p">;</span>
<a href="#__codelineno-2-6" id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-2-7" id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Data.Collections</span><span class="p">;</span>
<a href="#__codelineno-2-8" id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Communication.Runtime</span><span class="p">;</span>
<a href="#__codelineno-2-9" id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Runtime</span><span class="p">;</span>
<a href="#__codelineno-2-10" id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a href="#__codelineno-2-11" id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog</span>
<a href="#__codelineno-2-12" id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="p">{</span>
<a href="#__codelineno-2-13" id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-2-14" id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="c1">/// An instance of this class is created for each service replica by the Service Fabric runtime.</span>
<a href="#__codelineno-2-15" id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-2-16" id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="k">internal</span><span class="w"> </span><span class="k">sealed</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ProductCatalog</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">StatefulService</span>
<a href="#__codelineno-2-17" id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-2-18" id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">ProductCatalog</span><span class="p">(</span><span class="n">StatefulServiceContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-2-19" id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-2-20" id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-2-21" id="__codelineno-2-21" name="__codelineno-2-21"></a>
<a href="#__codelineno-2-22" id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-2-23" id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">        </span><span class="c1">/// Optional override to create listeners (e.g., HTTP, Service Remoting, WCF, etc.) for this service replica to handle client or user requests.</span>
<a href="#__codelineno-2-24" id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-2-25" id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">        </span><span class="c1">/// &lt;remarks&gt;</span>
<a href="#__codelineno-2-26" id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">        </span><span class="c1">/// For more information on service communication, see https://aka.ms/servicefabricservicecommunication</span>
<a href="#__codelineno-2-27" id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">        </span><span class="c1">/// &lt;/remarks&gt;</span>
<a href="#__codelineno-2-28" id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">        </span><span class="c1">/// &lt;returns&gt;A collection of listeners.&lt;/returns&gt;</span>
<a href="#__codelineno-2-29" id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">        </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">ServiceReplicaListener</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CreateServiceReplicaListeners</span><span class="p">()</span>
<a href="#__codelineno-2-30" id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-2-31" id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceReplicaListener</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<a href="#__codelineno-2-32" id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-2-33" id="__codelineno-2-33" name="__codelineno-2-33"></a>
<a href="#__codelineno-2-34" id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-2-35" id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">        </span><span class="c1">/// This is the main entry point for your service replica.</span>
<a href="#__codelineno-2-36" id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">        </span><span class="c1">/// This method executes when this replica of your service becomes primary and has write status.</span>
<a href="#__codelineno-2-37" id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-2-38" id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="w">        </span><span class="c1">/// &lt;param name="cancellationToken"&gt;Canceled when Service Fabric needs to shut down this service replica.&lt;/param&gt;</span>
<a href="#__codelineno-2-39" id="__codelineno-2-39" name="__codelineno-2-39"></a><span class="w">        </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">RunAsync</span><span class="p">(</span><span class="n">CancellationToken</span><span class="w"> </span><span class="n">cancellationToken</span><span class="p">)</span>
<a href="#__codelineno-2-40" id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-2-41" id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">            </span><span class="c1">// TODO: Replace the following sample code with your own logic </span>
<a href="#__codelineno-2-42" id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="w">            </span><span class="c1">//       or remove this RunAsync override if it's not needed in your service.</span>
<a href="#__codelineno-2-43" id="__codelineno-2-43" name="__codelineno-2-43"></a>
<a href="#__codelineno-2-44" id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">myDictionary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">StateManager</span><span class="p">.</span><span class="n">GetOrAddAsync</span><span class="o">&lt;</span><span class="n">IReliableDictionary</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"myDictionary"</span><span class="p">);</span>
<a href="#__codelineno-2-45" id="__codelineno-2-45" name="__codelineno-2-45"></a>
<a href="#__codelineno-2-46" id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
<a href="#__codelineno-2-47" id="__codelineno-2-47" name="__codelineno-2-47"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-2-48" id="__codelineno-2-48" name="__codelineno-2-48"></a><span class="w">                </span><span class="n">cancellationToken</span><span class="p">.</span><span class="n">ThrowIfCancellationRequested</span><span class="p">();</span>
<a href="#__codelineno-2-49" id="__codelineno-2-49" name="__codelineno-2-49"></a>
<a href="#__codelineno-2-50" id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">                </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="n">StateManager</span><span class="p">.</span><span class="n">CreateTransaction</span><span class="p">())</span>
<a href="#__codelineno-2-51" id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="w">                </span><span class="p">{</span>
<a href="#__codelineno-2-52" id="__codelineno-2-52" name="__codelineno-2-52"></a><span class="w">                    </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">myDictionary</span><span class="p">.</span><span class="n">TryGetValueAsync</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="s">"Counter"</span><span class="p">);</span>
<a href="#__codelineno-2-53" id="__codelineno-2-53" name="__codelineno-2-53"></a>
<a href="#__codelineno-2-54" id="__codelineno-2-54" name="__codelineno-2-54"></a><span class="w">                    </span><span class="n">ServiceEventSource</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">ServiceMessage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="s">"Current Counter Value: {0}"</span><span class="p">,</span>
<a href="#__codelineno-2-55" id="__codelineno-2-55" name="__codelineno-2-55"></a><span class="w">                        </span><span class="n">result</span><span class="p">.</span><span class="n">HasValue</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">ToString</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">"Value does not exist."</span><span class="p">);</span>
<a href="#__codelineno-2-56" id="__codelineno-2-56" name="__codelineno-2-56"></a>
<a href="#__codelineno-2-57" id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="w">                    </span><span class="k">await</span><span class="w"> </span><span class="n">myDictionary</span><span class="p">.</span><span class="n">AddOrUpdateAsync</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="s">"Counter"</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">++</span><span class="k">value</span><span class="p">);</span>
<a href="#__codelineno-2-58" id="__codelineno-2-58" name="__codelineno-2-58"></a>
<a href="#__codelineno-2-59" id="__codelineno-2-59" name="__codelineno-2-59"></a><span class="w">                    </span><span class="c1">// If an exception is thrown before calling CommitAsync, the transaction aborts, all changes are </span>
<a href="#__codelineno-2-60" id="__codelineno-2-60" name="__codelineno-2-60"></a><span class="w">                    </span><span class="c1">// discarded, and nothing is saved to the secondary replicas.</span>
<a href="#__codelineno-2-61" id="__codelineno-2-61" name="__codelineno-2-61"></a><span class="w">                    </span><span class="k">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">CommitAsync</span><span class="p">();</span>
<a href="#__codelineno-2-62" id="__codelineno-2-62" name="__codelineno-2-62"></a><span class="w">                </span><span class="p">}</span>
<a href="#__codelineno-2-63" id="__codelineno-2-63" name="__codelineno-2-63"></a>
<a href="#__codelineno-2-64" id="__codelineno-2-64" name="__codelineno-2-64"></a><span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">cancellationToken</span><span class="p">);</span>
<a href="#__codelineno-2-65" id="__codelineno-2-65" name="__codelineno-2-65"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-2-66" id="__codelineno-2-66" name="__codelineno-2-66"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-2-67" id="__codelineno-2-67" name="__codelineno-2-67"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-2-68" id="__codelineno-2-68" name="__codelineno-2-68"></a><span class="p">}</span>
</code></pre></div></p> <h3 id="service-lifecycle">Service Lifecycle<a class="headerlink" href="#service-lifecycle" title="Permanent link">¬∂</a></h3> <p><strong>Startup</strong> <pre class="mermaid"><code>sequenceDiagram
    participant ASF_Runtime
    participant Service_Instance
    loop
        ASF_Runtime-&gt;&gt;ASF_Runtime: create service instance
    end
    ASF_Runtime-&gt;&gt;Service_Instance: ask to create listeners
    Service_Instance--&gt;&gt;ASF_Runtime: listeners[]
    loop for each listener
        ASF_Runtime-&gt;Service_Instance: open listener
    end
    ASF_Runtime-&gt;&gt;Service_Instance: RunAsync(cancellationToken)</code></pre></p> <p><strong>Shutdown</strong> <pre class="mermaid"><code>sequenceDiagram
    participant ASF_Runtime
    participant Service_Instance
    loop
        ASF_Runtime-&gt;&gt;ASF_Runtime: cancel cancellation token passed in RunAsync
    end
    loop for each listener
        ASF_Runtime-&gt;Service_Instance: close
    end
    loop
        ASF_Runtime-&gt;&gt;ASF_Runtime: destroy class instance
    end</code></pre></p> <div class="admonition tip"> <p class="admonition-title">Tip</p> <div class="highlight"><span class="filename">Text Only</span><pre><span></span><code>It's very important to **always respond to cancellationToken event as soon as possible** if we run RunAsync all the time in the background
</code></pre></div> </div> <h3 id="creating-product-catalog-service">Creating Product Catalog Service<a class="headerlink" href="#creating-product-catalog-service" title="Permanent link">¬∂</a></h3> <p><strong>Product Entity</strong> <pre class="mermaid"><code>classDiagram
    class Product
    Product : +ProductId GUID
    Product : +Name string
    Product : +Description string 
    Product : +Price double
    Product : +Availability int</code></pre></p> <p>Now lets add IProuductRepostory and Product in library project and reference it from ProductCatalog Service project. <strong>IProductRepository</strong> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Text</span><span class="p">;</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog.Model</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="p">{</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">interface</span><span class="w"> </span><span class="n">IProductRepository</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">        </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GetProducts</span><span class="p">();</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">        </span><span class="n">Task</span><span class="w"> </span><span class="nf">AddProudct</span><span class="p">(</span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">);</span>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="p">}</span>
</code></pre></div></p> <p><strong>Product</strong> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-4-2" id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a href="#__codelineno-4-3" id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog.Model</span>
<a href="#__codelineno-4-4" id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="p">{</span>
<a href="#__codelineno-4-5" id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Product</span>
<a href="#__codelineno-4-6" id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-4-7" id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">Guid</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-4-8" id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-4-9" id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Description</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-4-10" id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">Price</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-4-11" id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">Availability</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-4-12" id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-4-13" id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="p">}</span>
</code></pre></div></p> <p>Let's create ServiceFabricProductRepository nad update ProductCatalog in ProductCatalog project. <strong>ServiceFabricProductRepository</strong> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-5-2" id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a href="#__codelineno-5-3" id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Text</span><span class="p">;</span>
<a href="#__codelineno-5-4" id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading</span><span class="p">;</span>
<a href="#__codelineno-5-5" id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-5-6" id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog.Model</span><span class="p">;</span>
<a href="#__codelineno-5-7" id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Data</span><span class="p">;</span>
<a href="#__codelineno-5-8" id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Data.Collections</span><span class="p">;</span>
<a href="#__codelineno-5-9" id="__codelineno-5-9" name="__codelineno-5-9"></a>
<a href="#__codelineno-5-10" id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog</span>
<a href="#__codelineno-5-11" id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="p">{</span>
<a href="#__codelineno-5-12" id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">ServcieFabricProductRepostiory</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IProductRepository</span>
<a href="#__codelineno-5-13" id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-5-14" id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">IReliableStateManager</span><span class="w"> </span><span class="n">_stateManager</span><span class="p">;</span>
<a href="#__codelineno-5-15" id="__codelineno-5-15" name="__codelineno-5-15"></a>
<a href="#__codelineno-5-16" id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">ServcieFabricProductRepostiory</span><span class="p">(</span><span class="n">IReliableStateManager</span><span class="w"> </span><span class="n">stateManager</span><span class="p">)</span>
<a href="#__codelineno-5-17" id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-5-18" id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">            </span><span class="n">_stateManager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stateManager</span><span class="p">;</span>
<a href="#__codelineno-5-19" id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-5-20" id="__codelineno-5-20" name="__codelineno-5-20"></a>
<a href="#__codelineno-5-21" id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">AddProudct</span><span class="p">(</span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">)</span>
<a href="#__codelineno-5-22" id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-5-23" id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_stateManager</span><span class="p">.</span><span class="n">GetOrAddAsync</span><span class="o">&lt;</span><span class="n">IReliableDictionary</span><span class="o">&lt;</span><span class="n">Guid</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"product"</span><span class="p">);</span>
<a href="#__codelineno-5-24" id="__codelineno-5-24" name="__codelineno-5-24"></a>
<a href="#__codelineno-5-25" id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">            </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="n">ITransaction</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stateManager</span><span class="p">.</span><span class="n">CreateTransaction</span><span class="p">())</span>
<a href="#__codelineno-5-26" id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-5-27" id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="n">products</span><span class="p">.</span><span class="n">AddOrUpdateAsync</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">product</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">product</span><span class="p">);</span>
<a href="#__codelineno-5-28" id="__codelineno-5-28" name="__codelineno-5-28"></a>
<a href="#__codelineno-5-29" id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">                </span><span class="k">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">CommitAsync</span><span class="p">();</span>
<a href="#__codelineno-5-30" id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-5-31" id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-5-32" id="__codelineno-5-32" name="__codelineno-5-32"></a>
<a href="#__codelineno-5-33" id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GetProducts</span><span class="p">()</span>
<a href="#__codelineno-5-34" id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-5-35" id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">products</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_stateManager</span><span class="p">.</span><span class="n">GetOrAddAsync</span><span class="o">&lt;</span><span class="n">IReliableDictionary</span><span class="o">&lt;</span><span class="n">Guid</span><span class="p">,</span><span class="w"> </span><span class="n">Product</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="s">"product"</span><span class="p">);</span>
<a href="#__codelineno-5-36" id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Product</span><span class="o">&gt;</span><span class="p">();</span>
<a href="#__codelineno-5-37" id="__codelineno-5-37" name="__codelineno-5-37"></a>
<a href="#__codelineno-5-38" id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">            </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="n">ITransaction</span><span class="w"> </span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_stateManager</span><span class="p">.</span><span class="n">CreateTransaction</span><span class="p">())</span>
<a href="#__codelineno-5-39" id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-5-40" id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="w">                </span><span class="kt">var</span><span class="w"> </span><span class="n">allProducts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">products</span><span class="p">.</span><span class="n">CreateEnumerableAsync</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="w"> </span><span class="n">EnumerationMode</span><span class="p">.</span><span class="n">Unordered</span><span class="p">);</span>
<a href="#__codelineno-5-41" id="__codelineno-5-41" name="__codelineno-5-41"></a>
<a href="#__codelineno-5-42" id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="w">                </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="kt">var</span><span class="w"> </span><span class="n">enumerator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allProducts</span><span class="p">.</span><span class="n">GetAsyncEnumerator</span><span class="p">())</span>
<a href="#__codelineno-5-43" id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="w">                </span><span class="p">{</span>
<a href="#__codelineno-5-44" id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="w">                    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="n">enumerator</span><span class="p">.</span><span class="n">MoveNextAsync</span><span class="p">(</span><span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">))</span>
<a href="#__codelineno-5-45" id="__codelineno-5-45" name="__codelineno-5-45"></a><span class="w">                    </span><span class="p">{</span>
<a href="#__codelineno-5-46" id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">                        </span><span class="n">result</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">enumerator</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
<a href="#__codelineno-5-47" id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">                    </span><span class="p">}</span>
<a href="#__codelineno-5-48" id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="w">                </span><span class="p">}</span>
<a href="#__codelineno-5-49" id="__codelineno-5-49" name="__codelineno-5-49"></a><span class="w">            </span><span class="p">}</span>
<a href="#__codelineno-5-50" id="__codelineno-5-50" name="__codelineno-5-50"></a>
<a href="#__codelineno-5-51" id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<a href="#__codelineno-5-52" id="__codelineno-5-52" name="__codelineno-5-52"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-5-53" id="__codelineno-5-53" name="__codelineno-5-53"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-5-54" id="__codelineno-5-54" name="__codelineno-5-54"></a><span class="p">}</span>
</code></pre></div></p> <p><strong>ProductCatalog</strong> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-6-2" id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a href="#__codelineno-6-3" id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Fabric</span><span class="p">;</span>
<a href="#__codelineno-6-4" id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a href="#__codelineno-6-5" id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading</span><span class="p">;</span>
<a href="#__codelineno-6-6" id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-6-7" id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="k">using</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog.Model</span><span class="p">;</span>
<a href="#__codelineno-6-8" id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Data.Collections</span><span class="p">;</span>
<a href="#__codelineno-6-9" id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Communication.Runtime</span><span class="p">;</span>
<a href="#__codelineno-6-10" id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Runtime</span><span class="p">;</span>
<a href="#__codelineno-6-11" id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a href="#__codelineno-6-12" id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog</span>
<a href="#__codelineno-6-13" id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="p">{</span>
<a href="#__codelineno-6-14" id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-6-15" id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="c1">/// An instance of this class is created for each service replica by the Service Fabric runtime.</span>
<a href="#__codelineno-6-16" id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-6-17" id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="k">internal</span><span class="w"> </span><span class="k">sealed</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ProductCatalog</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">StatefulService</span>
<a href="#__codelineno-6-18" id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-6-19" id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">ServcieFabricProductRepostiory</span><span class="w"> </span><span class="n">_repo</span><span class="p">;</span>
<a href="#__codelineno-6-20" id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">ProductCatalog</span><span class="p">(</span><span class="n">StatefulServiceContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-6-21" id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-6-22" id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-6-23" id="__codelineno-6-23" name="__codelineno-6-23"></a>
<a href="#__codelineno-6-24" id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-6-25" id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">        </span><span class="c1">/// Optional override to create listeners (e.g., HTTP, Service Remoting, WCF, etc.) for this service replica to handle client or user requests.</span>
<a href="#__codelineno-6-26" id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-6-27" id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">        </span><span class="c1">/// &lt;remarks&gt;</span>
<a href="#__codelineno-6-28" id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="c1">/// For more information on service communication, see https://aka.ms/servicefabricservicecommunication</span>
<a href="#__codelineno-6-29" id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">        </span><span class="c1">/// &lt;/remarks&gt;</span>
<a href="#__codelineno-6-30" id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">        </span><span class="c1">/// &lt;returns&gt;A collection of listeners.&lt;/returns&gt;</span>
<a href="#__codelineno-6-31" id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">        </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">ServiceReplicaListener</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CreateServiceReplicaListeners</span><span class="p">()</span>
<a href="#__codelineno-6-32" id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-6-33" id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceReplicaListener</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
<a href="#__codelineno-6-34" id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-6-35" id="__codelineno-6-35" name="__codelineno-6-35"></a>
<a href="#__codelineno-6-36" id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-6-37" id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">        </span><span class="c1">/// This is the main entry point for your service replica.</span>
<a href="#__codelineno-6-38" id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">        </span><span class="c1">/// This method executes when this replica of your service becomes primary and has write status.</span>
<a href="#__codelineno-6-39" id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-6-40" id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">        </span><span class="c1">/// &lt;param name="cancellationToken"&gt;Canceled when Service Fabric needs to shut down this service replica.&lt;/param&gt;</span>
<a href="#__codelineno-6-41" id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="w">        </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">RunAsync</span><span class="p">(</span><span class="n">CancellationToken</span><span class="w"> </span><span class="n">cancellationToken</span><span class="p">)</span>
<a href="#__codelineno-6-42" id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-6-43" id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">product1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Product</span>
<a href="#__codelineno-6-44" id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-6-45" id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span>
<a href="#__codelineno-6-46" id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Dell Monitor"</span><span class="p">,</span>
<a href="#__codelineno-6-47" id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">" Computer Monitor"</span><span class="p">,</span>
<a href="#__codelineno-6-48" id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span>
<a href="#__codelineno-6-49" id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">                </span><span class="n">Availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<a href="#__codelineno-6-50" id="__codelineno-6-50" name="__codelineno-6-50"></a><span class="w">            </span><span class="p">};</span>
<a href="#__codelineno-6-51" id="__codelineno-6-51" name="__codelineno-6-51"></a>
<a href="#__codelineno-6-52" id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">product2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Product</span>
<a href="#__codelineno-6-53" id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-6-54" id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span>
<a href="#__codelineno-6-55" id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Keyboard"</span><span class="p">,</span>
<a href="#__codelineno-6-56" id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">" Computer Accesories"</span><span class="p">,</span>
<a href="#__codelineno-6-57" id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">510</span><span class="p">,</span>
<a href="#__codelineno-6-58" id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">                </span><span class="n">Availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">110</span>
<a href="#__codelineno-6-59" id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="w">            </span><span class="p">};</span>
<a href="#__codelineno-6-60" id="__codelineno-6-60" name="__codelineno-6-60"></a>
<a href="#__codelineno-6-61" id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">product3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Product</span>
<a href="#__codelineno-6-62" id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-6-63" id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span>
<a href="#__codelineno-6-64" id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Mouse"</span><span class="p">,</span>
<a href="#__codelineno-6-65" id="__codelineno-6-65" name="__codelineno-6-65"></a><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">" Computer Accesories"</span><span class="p">,</span>
<a href="#__codelineno-6-66" id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">520</span><span class="p">,</span>
<a href="#__codelineno-6-67" id="__codelineno-6-67" name="__codelineno-6-67"></a><span class="w">                </span><span class="n">Availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">120</span>
<a href="#__codelineno-6-68" id="__codelineno-6-68" name="__codelineno-6-68"></a><span class="w">            </span><span class="p">};</span>
<a href="#__codelineno-6-69" id="__codelineno-6-69" name="__codelineno-6-69"></a>
<a href="#__codelineno-6-70" id="__codelineno-6-70" name="__codelineno-6-70"></a><span class="w">            </span><span class="n">_repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServcieFabricProductRepostiory</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">StateManager</span><span class="p">);</span>
<a href="#__codelineno-6-71" id="__codelineno-6-71" name="__codelineno-6-71"></a>
<a href="#__codelineno-6-72" id="__codelineno-6-72" name="__codelineno-6-72"></a><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">AddProudct</span><span class="p">(</span><span class="n">product1</span><span class="p">);</span>
<a href="#__codelineno-6-73" id="__codelineno-6-73" name="__codelineno-6-73"></a><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">AddProudct</span><span class="p">(</span><span class="n">product2</span><span class="p">);</span>
<a href="#__codelineno-6-74" id="__codelineno-6-74" name="__codelineno-6-74"></a><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">AddProudct</span><span class="p">(</span><span class="n">product3</span><span class="p">);</span>
<a href="#__codelineno-6-75" id="__codelineno-6-75" name="__codelineno-6-75"></a>
<a href="#__codelineno-6-76" id="__codelineno-6-76" name="__codelineno-6-76"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">GetProducts</span><span class="p">();</span>
<a href="#__codelineno-6-77" id="__codelineno-6-77" name="__codelineno-6-77"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-6-78" id="__codelineno-6-78" name="__codelineno-6-78"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-6-79" id="__codelineno-6-79" name="__codelineno-6-79"></a><span class="p">}</span>
</code></pre></div> At this point we should be able to run the application and check there are 3 products in all variable which is await of GetProducts()</p> <p>This is how the solution should look like: <a class="glightbox" data-desc-position="bottom" data-description="" data-height="auto" data-title="" data-width="100%" href="../../assets/images/ECommerce_Sln.png"><img alt="ECommerce Solution" src="../../assets/images/ECommerce_Sln.png"/></a></p> <p>:::warning Visual Studio need to run in elevated mode as Admin to allow access network level resources :::</p> <h3 id="creating-a-web-api">Creating a Web API<a class="headerlink" href="#creating-a-web-api" title="Permanent link">¬∂</a></h3> <p>To add new Stateless ASP .net Core Web API, right click on ECommerce project and add New Service Fabric Service and choose, stateless asp.net core API. <a class="glightbox" data-desc-position="bottom" data-description="" data-height="auto" data-title="" data-width="100%" href="../../assets/images/SF_Create_WebAPI.png"><img alt="New API" src="../../assets/images/SF_Create_WebAPI.png"/></a></p> <p>Program.cs is console application very similar to previous one which resisters the service type.</p> <p>API <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Fabric</span><span class="p">;</span>
<a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.IO</span><span class="p">;</span>
<a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.AspNetCore.Hosting</span><span class="p">;</span>
<a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>
<a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Communication.AspNetCore</span><span class="p">;</span>
<a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Communication.Runtime</span><span class="p">;</span>
<a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Runtime</span><span class="p">;</span>
<a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a>
<a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.API</span>
<a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="p">{</span>
<a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="c1">/// The FabricRuntime creates an instance of this class for each service type instance. </span>
<a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">    </span><span class="k">internal</span><span class="w"> </span><span class="k">sealed</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">API</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">StatelessService</span>
<a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">API</span><span class="p">(</span><span class="n">StatelessServiceContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>
<a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">        </span><span class="c1">/// Optional override to create listeners (like tcp, http) for this service instance.</span>
<a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-7-24" id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">        </span><span class="c1">/// &lt;returns&gt;The collection of listeners.&lt;/returns&gt;</span>
<a href="#__codelineno-7-25" id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">        </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">ServiceInstanceListener</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CreateServiceInstanceListeners</span><span class="p">()</span>
<a href="#__codelineno-7-26" id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-7-27" id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceInstanceListener</span><span class="p">[]</span>
<a href="#__codelineno-7-28" id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-7-29" id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="nf">ServiceInstanceListener</span><span class="p">(</span><span class="n">serviceContext</span><span class="w"> </span><span class="o">=&gt;</span>
<a href="#__codelineno-7-30" id="__codelineno-7-30" name="__codelineno-7-30"></a><span class="hll"><span class="w">                    </span><span class="k">new</span><span class="w"> </span><span class="nf">KestrelCommunicationListener</span><span class="p">(</span><span class="n">serviceContext</span><span class="p">,</span><span class="w"> </span><span class="s">"ServiceEndpoint"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">listener</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span>
</span><a href="#__codelineno-7-31" id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="w">                    </span><span class="p">{</span>
<a href="#__codelineno-7-32" id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">                        </span><span class="n">ServiceEventSource</span><span class="p">.</span><span class="n">Current</span><span class="p">.</span><span class="n">ServiceMessage</span><span class="p">(</span><span class="n">serviceContext</span><span class="p">,</span><span class="w"> </span><span class="s">$"Starting Kestrel on {url}"</span><span class="p">);</span>
<a href="#__codelineno-7-33" id="__codelineno-7-33" name="__codelineno-7-33"></a>
<a href="#__codelineno-7-34" id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nf">WebHostBuilder</span><span class="p">()</span>
<a href="#__codelineno-7-35" id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">                                    </span><span class="p">.</span><span class="n">UseKestrel</span><span class="p">()</span>
<a href="#__codelineno-7-36" id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">                                    </span><span class="p">.</span><span class="n">ConfigureServices</span><span class="p">(</span>
<a href="#__codelineno-7-37" id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">                                        </span><span class="n">services</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">services</span>
<a href="#__codelineno-7-38" id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">                                            </span><span class="p">.</span><span class="n">AddSingleton</span><span class="o">&lt;</span><span class="n">StatelessServiceContext</span><span class="o">&gt;</span><span class="p">(</span><span class="n">serviceContext</span><span class="p">))</span>
<a href="#__codelineno-7-39" id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="w">                                    </span><span class="p">.</span><span class="n">UseContentRoot</span><span class="p">(</span><span class="n">Directory</span><span class="p">.</span><span class="n">GetCurrentDirectory</span><span class="p">())</span>
<a href="#__codelineno-7-40" id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="w">                                    </span><span class="p">.</span><span class="n">UseStartup</span><span class="o">&lt;</span><span class="n">Startup</span><span class="o">&gt;</span><span class="p">()</span>
<a href="#__codelineno-7-41" id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="w">                                    </span><span class="p">.</span><span class="n">UseServiceFabricIntegration</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceFabricIntegrationOptions</span><span class="p">.</span><span class="n">None</span><span class="p">)</span>
<a href="#__codelineno-7-42" id="__codelineno-7-42" name="__codelineno-7-42"></a><span class="w">                                    </span><span class="p">.</span><span class="n">UseUrls</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<a href="#__codelineno-7-43" id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="w">                                    </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>
<a href="#__codelineno-7-44" id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="w">                    </span><span class="p">}))</span>
<a href="#__codelineno-7-45" id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="w">            </span><span class="p">};</span>
<a href="#__codelineno-7-46" id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-7-47" id="__codelineno-7-47" name="__codelineno-7-47"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-7-48" id="__codelineno-7-48" name="__codelineno-7-48"></a><span class="p">}</span>
</code></pre></div> <strong>KestrelCommunicationListener</strong> is standard fabric listener which bootstrap asp.net core runtime and configure it to run inside service fabric environment.</p> <p>Let's add Product Api Model <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">Newtonsoft.Json</span><span class="p">;</span>
<a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a>
<a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.API.Model</span>
<a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="p">{</span>
<a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ApiProduct</span>
<a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">        </span><span class="na">[JsonProperty("id")]</span>
<a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="n">Guid</span><span class="w"> </span><span class="n">Id</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="na">[JsonProperty("name")]</span>
<a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Name</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">        </span><span class="na">[JsonProperty("description")]</span>
<a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="n">Description</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">        </span><span class="na">[JsonProperty("price")]</span>
<a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">Price</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">        </span><span class="na">[JsonProperty("isAvailable")]</span>
<a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">IsAvailable</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">get</span><span class="p">;</span><span class="w"> </span><span class="k">set</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-8-19" id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="p">}</span>
</code></pre></div></p> <p>Here is new project structure: <a class="glightbox" data-desc-position="bottom" data-description="" data-height="auto" data-title="" data-width="100%" href="../../assets/images/ECommerce1_Sln.png"><img alt="Solution" src="../../assets/images/ECommerce1_Sln.png"/></a></p> <h3 id="communicating-between-two-services">Communicating between two services<a class="headerlink" href="#communicating-between-two-services" title="Permanent link">¬∂</a></h3> <p>Let's say there are 3 nodes in a cluster <pre class="mermaid"><code>graph LR
    subgraph node3
        a(Service API - active) &amp; b(Catalog Service - passive)
    end
    subgraph node2
        c(Service API - active) &amp; d(Catalog Service - active)
    end
    subgraph node1
        e(Service API - active) &amp; f(Catalog Service - passive)
    end</code></pre> Since API are stateless they are active in all nodes but Catalog Service is stateful so Service Fabric makes one active and other two passive in case of fail over.</p> <div class="admonition tip"> <p class="admonition-title">Tip</p> <div class="highlight"><span class="filename">Text Only</span><pre><span></span><code>Never assume a service is running in a fixed location. Services in Service Fabric can move around and change roles all the time during the lifetime of the application and even between requests. Therefore, before making the request we should always query the service location from Service Fabric runtime.
</code></pre></div> </div> <p>Service Fabric is protocol agnostic. Out of the box there are three protocols: * WCF * HTTP * Service Remoting (Default protocol for reliable communication)</p> <p>Benefits of using Service Remoting: * Automatic service address resolution * Establishing connection * Retries * Error handling * Strong typed * Fast</p> <p>For the purpose of remoting we are adding Service interface in the Model <strong>IProductCatalogService</strong> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Remoting</span><span class="p">;</span>
<a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog.Model</span>
<a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="p">{</span>
<a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">interface</span><span class="w"> </span><span class="n">IProductCatalogService</span><span class="p">:</span><span class="w"> </span><span class="n">IService</span>
<a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">        </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">Product</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetALlProductsAsync</span><span class="p">();</span>
<a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">        </span><span class="n">Task</span><span class="w"> </span><span class="nf">AddProductAsync</span><span class="p">(</span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">);</span>
<a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="p">}</span>
</code></pre></div> We need to install the remoting service library. <a class="glightbox" data-desc-position="bottom" data-description="" data-height="auto" data-title="" data-width="100%" href="../../assets/images/SF_Add_Remoting_Service_lib.png"><img alt="Remoting service library" src="../../assets/images/SF_Add_Remoting_Service_lib.png"/></a></p> <p>And implement IProductCatalogService in ProductCatalog</p> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Fabric</span><span class="p">;</span>
<a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading</span><span class="p">;</span>
<a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="k">using</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog.Model</span><span class="p">;</span>
<a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Communication.Runtime</span><span class="p">;</span>
<a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Remoting.V2.FabricTransport.Runtime</span><span class="p">;</span>
<a href="#__codelineno-10-10" id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Runtime</span><span class="p">;</span>
<a href="#__codelineno-10-11" id="__codelineno-10-11" name="__codelineno-10-11"></a>
<a href="#__codelineno-10-12" id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog</span>
<a href="#__codelineno-10-13" id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="p">{</span>
<a href="#__codelineno-10-14" id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="w">    </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-10-15" id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="w">    </span><span class="c1">/// An instance of this class is created for each service replica by the Service Fabric runtime.</span>
<a href="#__codelineno-10-16" id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">    </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-10-17" id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="k">internal</span><span class="w"> </span><span class="k">sealed</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ProductCatalog</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">StatefulService</span><span class="p">,</span><span class="w"> </span><span class="n">IProductCatalogService</span>
<a href="#__codelineno-10-18" id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-10-19" id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="n">ServiceFabricProductRepository</span><span class="w"> </span><span class="n">_repo</span><span class="p">;</span>
<a href="#__codelineno-10-20" id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">ProductCatalog</span><span class="p">(</span><span class="n">StatefulServiceContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-10-21" id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="k">base</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a href="#__codelineno-10-22" id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<a href="#__codelineno-10-23" id="__codelineno-10-23" name="__codelineno-10-23"></a>
<a href="#__codelineno-10-24" id="__codelineno-10-24" name="__codelineno-10-24"></a><span class="hll"><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">AddProductAsync</span><span class="p">(</span><span class="n">Product</span><span class="w"> </span><span class="n">product</span><span class="p">)</span>
</span><a href="#__codelineno-10-25" id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="hll"><span class="w">        </span><span class="p">{</span>
</span><a href="#__codelineno-10-26" id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="hll"><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">AddProduct</span><span class="p">(</span><span class="n">product</span><span class="p">);</span>
</span><a href="#__codelineno-10-27" id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><a href="#__codelineno-10-28" id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="hll">
</span><a href="#__codelineno-10-29" id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="hll"><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">Product</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetALlProductsAsync</span><span class="p">()</span>
</span><a href="#__codelineno-10-30" id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="hll"><span class="w">        </span><span class="p">{</span>
</span><a href="#__codelineno-10-31" id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">GetProducts</span><span class="p">()).</span><span class="n">ToArray</span><span class="p">();</span>
</span><a href="#__codelineno-10-32" id="__codelineno-10-32" name="__codelineno-10-32"></a><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><a href="#__codelineno-10-33" id="__codelineno-10-33" name="__codelineno-10-33"></a>
<a href="#__codelineno-10-34" id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-10-35" id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">        </span><span class="c1">/// Optional override to create listeners (e.g., HTTP, Service Remoting, WCF, etc.) for this service replica to handle client or user requests.</span>
<a href="#__codelineno-10-36" id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-10-37" id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">        </span><span class="c1">/// &lt;remarks&gt;</span>
<a href="#__codelineno-10-38" id="__codelineno-10-38" name="__codelineno-10-38"></a><span class="w">        </span><span class="c1">/// For more information on service communication, see https://aka.ms/servicefabricservicecommunication</span>
<a href="#__codelineno-10-39" id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="w">        </span><span class="c1">/// &lt;/remarks&gt;</span>
<a href="#__codelineno-10-40" id="__codelineno-10-40" name="__codelineno-10-40"></a><span class="w">        </span><span class="c1">/// &lt;returns&gt;A collection of listeners.&lt;/returns&gt;</span>
<a href="#__codelineno-10-41" id="__codelineno-10-41" name="__codelineno-10-41"></a><span class="w">        </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">ServiceReplicaListener</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CreateServiceReplicaListeners</span><span class="p">()</span>
<a href="#__codelineno-10-42" id="__codelineno-10-42" name="__codelineno-10-42"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-10-43" id="__codelineno-10-43" name="__codelineno-10-43"></a><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="p">[]</span>
</span><a href="#__codelineno-10-44" id="__codelineno-10-44" name="__codelineno-10-44"></a><span class="hll"><span class="w">            </span><span class="p">{</span>
</span><a href="#__codelineno-10-45" id="__codelineno-10-45" name="__codelineno-10-45"></a><span class="hll"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="nf">ServiceReplicaListener</span><span class="p">(</span><span class="n">context</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FabricTransportServiceRemotingListener</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">))</span>
</span><a href="#__codelineno-10-46" id="__codelineno-10-46" name="__codelineno-10-46"></a><span class="hll"><span class="w">            </span><span class="p">};</span>
</span><a href="#__codelineno-10-47" id="__codelineno-10-47" name="__codelineno-10-47"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-10-48" id="__codelineno-10-48" name="__codelineno-10-48"></a>
<a href="#__codelineno-10-49" id="__codelineno-10-49" name="__codelineno-10-49"></a><span class="w">        </span><span class="c1">/// &lt;summary&gt;</span>
<a href="#__codelineno-10-50" id="__codelineno-10-50" name="__codelineno-10-50"></a><span class="w">        </span><span class="c1">/// This is the main entry point for your service replica.</span>
<a href="#__codelineno-10-51" id="__codelineno-10-51" name="__codelineno-10-51"></a><span class="w">        </span><span class="c1">/// This method executes when this replica of your service becomes primary and has write status.</span>
<a href="#__codelineno-10-52" id="__codelineno-10-52" name="__codelineno-10-52"></a><span class="w">        </span><span class="c1">/// &lt;/summary&gt;</span>
<a href="#__codelineno-10-53" id="__codelineno-10-53" name="__codelineno-10-53"></a><span class="w">        </span><span class="c1">/// &lt;param name="cancellationToken"&gt;Canceled when Service Fabric needs to shut down this service replica.&lt;/param&gt;</span>
<a href="#__codelineno-10-54" id="__codelineno-10-54" name="__codelineno-10-54"></a><span class="w">        </span><span class="k">protected</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">RunAsync</span><span class="p">(</span><span class="n">CancellationToken</span><span class="w"> </span><span class="n">cancellationToken</span><span class="p">)</span>
<a href="#__codelineno-10-55" id="__codelineno-10-55" name="__codelineno-10-55"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-10-56" id="__codelineno-10-56" name="__codelineno-10-56"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">product1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Product</span>
<a href="#__codelineno-10-57" id="__codelineno-10-57" name="__codelineno-10-57"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-10-58" id="__codelineno-10-58" name="__codelineno-10-58"></a><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span>
<a href="#__codelineno-10-59" id="__codelineno-10-59" name="__codelineno-10-59"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Dell Monitor"</span><span class="p">,</span>
<a href="#__codelineno-10-60" id="__codelineno-10-60" name="__codelineno-10-60"></a><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">" Computer Monitor"</span><span class="p">,</span>
<a href="#__codelineno-10-61" id="__codelineno-10-61" name="__codelineno-10-61"></a><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">500</span><span class="p">,</span>
<a href="#__codelineno-10-62" id="__codelineno-10-62" name="__codelineno-10-62"></a><span class="w">                </span><span class="n">Availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<a href="#__codelineno-10-63" id="__codelineno-10-63" name="__codelineno-10-63"></a><span class="w">            </span><span class="p">};</span>
<a href="#__codelineno-10-64" id="__codelineno-10-64" name="__codelineno-10-64"></a>
<a href="#__codelineno-10-65" id="__codelineno-10-65" name="__codelineno-10-65"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">product2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Product</span>
<a href="#__codelineno-10-66" id="__codelineno-10-66" name="__codelineno-10-66"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-10-67" id="__codelineno-10-67" name="__codelineno-10-67"></a><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span>
<a href="#__codelineno-10-68" id="__codelineno-10-68" name="__codelineno-10-68"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Keyboard"</span><span class="p">,</span>
<a href="#__codelineno-10-69" id="__codelineno-10-69" name="__codelineno-10-69"></a><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">" Computer Accessories"</span><span class="p">,</span>
<a href="#__codelineno-10-70" id="__codelineno-10-70" name="__codelineno-10-70"></a><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">510</span><span class="p">,</span>
<a href="#__codelineno-10-71" id="__codelineno-10-71" name="__codelineno-10-71"></a><span class="w">                </span><span class="n">Availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">110</span>
<a href="#__codelineno-10-72" id="__codelineno-10-72" name="__codelineno-10-72"></a><span class="w">            </span><span class="p">};</span>
<a href="#__codelineno-10-73" id="__codelineno-10-73" name="__codelineno-10-73"></a>
<a href="#__codelineno-10-74" id="__codelineno-10-74" name="__codelineno-10-74"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">product3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Product</span>
<a href="#__codelineno-10-75" id="__codelineno-10-75" name="__codelineno-10-75"></a><span class="w">            </span><span class="p">{</span>
<a href="#__codelineno-10-76" id="__codelineno-10-76" name="__codelineno-10-76"></a><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span>
<a href="#__codelineno-10-77" id="__codelineno-10-77" name="__codelineno-10-77"></a><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Mouse"</span><span class="p">,</span>
<a href="#__codelineno-10-78" id="__codelineno-10-78" name="__codelineno-10-78"></a><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">" Computer Accessories"</span><span class="p">,</span>
<a href="#__codelineno-10-79" id="__codelineno-10-79" name="__codelineno-10-79"></a><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">520</span><span class="p">,</span>
<a href="#__codelineno-10-80" id="__codelineno-10-80" name="__codelineno-10-80"></a><span class="w">                </span><span class="n">Availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">120</span>
<a href="#__codelineno-10-81" id="__codelineno-10-81" name="__codelineno-10-81"></a><span class="w">            </span><span class="p">};</span>
<a href="#__codelineno-10-82" id="__codelineno-10-82" name="__codelineno-10-82"></a>
<a href="#__codelineno-10-83" id="__codelineno-10-83" name="__codelineno-10-83"></a><span class="w">            </span><span class="n">_repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceFabricProductRepository</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">StateManager</span><span class="p">);</span>
<a href="#__codelineno-10-84" id="__codelineno-10-84" name="__codelineno-10-84"></a>
<a href="#__codelineno-10-85" id="__codelineno-10-85" name="__codelineno-10-85"></a><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">AddProduct</span><span class="p">(</span><span class="n">product1</span><span class="p">);</span>
<a href="#__codelineno-10-86" id="__codelineno-10-86" name="__codelineno-10-86"></a><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">AddProduct</span><span class="p">(</span><span class="n">product2</span><span class="p">);</span>
<a href="#__codelineno-10-87" id="__codelineno-10-87" name="__codelineno-10-87"></a><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">AddProduct</span><span class="p">(</span><span class="n">product3</span><span class="p">);</span>
<a href="#__codelineno-10-88" id="__codelineno-10-88" name="__codelineno-10-88"></a>
<a href="#__codelineno-10-89" id="__codelineno-10-89" name="__codelineno-10-89"></a><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_repo</span><span class="p">.</span><span class="n">GetProducts</span><span class="p">();</span>
<a href="#__codelineno-10-90" id="__codelineno-10-90" name="__codelineno-10-90"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-10-91" id="__codelineno-10-91" name="__codelineno-10-91"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-10-92" id="__codelineno-10-92" name="__codelineno-10-92"></a><span class="p">}</span>
</code></pre></div> <div class="admonition tip"> <p class="admonition-title">Tip</p> <div class="highlight"><span class="filename">Text Only</span><pre><span></span><code>The return type must be array as the service remoting doesn't understand IEnumerable and it needs to transform over the networks it should be simple type.
</code></pre></div> </div> <p>Finally it's time to add proxy in API to connect to ProductCatalogService. <strong>ProductController</strong> <div class="highlight"><span class="filename">C#</span><pre><span></span><code><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="k">using</span><span class="w"> </span><span class="nn">System</span><span class="p">;</span>
<a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Collections.Generic</span><span class="p">;</span>
<a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Linq</span><span class="p">;</span>
<a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="k">using</span><span class="w"> </span><span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="k">using</span><span class="w"> </span><span class="nn">ECommerce.API.Model</span><span class="p">;</span>
<a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="k">using</span><span class="w"> </span><span class="nn">ECommerce.ProductCatalog.Model</span><span class="p">;</span>
<a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.AspNetCore.Mvc</span><span class="p">;</span>
<a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Client</span><span class="p">;</span>
<a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Remoting.Client</span><span class="p">;</span>
<a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="k">using</span><span class="w"> </span><span class="nn">Microsoft.ServiceFabric.Services.Remoting.V2.FabricTransport.Client</span><span class="p">;</span>
<a href="#__codelineno-11-11" id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a href="#__codelineno-11-12" id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="k">namespace</span><span class="w"> </span><span class="nn">ECommerce.API.Controllers</span>
<a href="#__codelineno-11-13" id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="p">{</span>
<a href="#__codelineno-11-14" id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span><span class="na">[ApiController]</span>
<a href="#__codelineno-11-15" id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="na">[Route("[controller]</span><span class="s">")]</span>
<a href="#__codelineno-11-16" id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">ProductsController</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ControllerBase</span>
<a href="#__codelineno-11-17" id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="p">{</span>
<a href="#__codelineno-11-18" id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">        </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="n">IProductCatalogService</span><span class="w"> </span><span class="n">_service</span><span class="p">;</span>
<a href="#__codelineno-11-19" id="__codelineno-11-19" name="__codelineno-11-19"></a>
<a href="#__codelineno-11-20" id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="hll"><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="nf">ProductsController</span><span class="p">()</span>
</span><a href="#__codelineno-11-21" id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="hll"><span class="w">        </span><span class="p">{</span>
</span><a href="#__codelineno-11-22" id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="hll"><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">proxyFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServiceProxyFactory</span><span class="p">(</span>
</span><a href="#__codelineno-11-23" id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="hll"><span class="w">                </span><span class="n">c</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FabricTransportServiceRemotingClientFactory</span><span class="p">());</span>
</span><a href="#__codelineno-11-24" id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="hll">
</span><a href="#__codelineno-11-25" id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="hll"><span class="w">            </span><span class="n">_service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proxyFactory</span><span class="p">.</span><span class="n">CreateServiceProxy</span><span class="o">&lt;</span><span class="n">IProductCatalogService</span><span class="o">&gt;</span><span class="p">(</span>
</span><a href="#__codelineno-11-26" id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="hll"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="nf">Uri</span><span class="p">(</span><span class="s">"fabric:/ECommerce/ECommerce.ProductCatalog"</span><span class="p">),</span>
</span><a href="#__codelineno-11-27" id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="hll"><span class="w">                </span><span class="k">new</span><span class="w"> </span><span class="nf">ServicePartitionKey</span><span class="p">(</span><span class="m">0</span><span class="p">));</span>
</span><a href="#__codelineno-11-28" id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><a href="#__codelineno-11-29" id="__codelineno-11-29" name="__codelineno-11-29"></a>
<a href="#__codelineno-11-30" id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">        </span><span class="na">[HttpGet]</span>
<a href="#__codelineno-11-31" id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="o">&lt;</span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">ApiProduct</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">GetAsync</span><span class="p">()</span>
<a href="#__codelineno-11-32" id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-11-33" id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="hll"><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">allProducts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">_service</span><span class="p">.</span><span class="n">GetAllProductsAsync</span><span class="p">();</span>
</span><a href="#__codelineno-11-34" id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="hll">
</span><a href="#__codelineno-11-35" id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">allProducts</span><span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ApiProduct</span>
</span><a href="#__codelineno-11-36" id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="hll"><span class="w">            </span><span class="p">{</span>
</span><a href="#__codelineno-11-37" id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="hll"><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
</span><a href="#__codelineno-11-38" id="__codelineno-11-38" name="__codelineno-11-38"></a><span class="hll"><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
</span><a href="#__codelineno-11-39" id="__codelineno-11-39" name="__codelineno-11-39"></a><span class="hll"><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span>
</span><a href="#__codelineno-11-40" id="__codelineno-11-40" name="__codelineno-11-40"></a><span class="hll"><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span>
</span><a href="#__codelineno-11-41" id="__codelineno-11-41" name="__codelineno-11-41"></a><span class="hll"><span class="w">                </span><span class="n">IsAvailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">Availability</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span>
</span><a href="#__codelineno-11-42" id="__codelineno-11-42" name="__codelineno-11-42"></a><span class="hll"><span class="w">            </span><span class="p">});</span>
</span><a href="#__codelineno-11-43" id="__codelineno-11-43" name="__codelineno-11-43"></a><span class="w">        </span><span class="p">}</span>
<a href="#__codelineno-11-44" id="__codelineno-11-44" name="__codelineno-11-44"></a>
<a href="#__codelineno-11-45" id="__codelineno-11-45" name="__codelineno-11-45"></a><span class="w">        </span><span class="na">[HttpPost]</span>
<a href="#__codelineno-11-46" id="__codelineno-11-46" name="__codelineno-11-46"></a><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="nf">PostAsync</span><span class="p">([</span><span class="n">FromBody</span><span class="p">]</span><span class="w"> </span><span class="n">ApiProduct</span><span class="w"> </span><span class="n">product</span><span class="p">)</span>
<a href="#__codelineno-11-47" id="__codelineno-11-47" name="__codelineno-11-47"></a><span class="w">        </span><span class="p">{</span>
<a href="#__codelineno-11-48" id="__codelineno-11-48" name="__codelineno-11-48"></a><span class="hll"><span class="w">            </span><span class="kt">var</span><span class="w"> </span><span class="n">newProduct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Product</span><span class="p">()</span>
</span><a href="#__codelineno-11-49" id="__codelineno-11-49" name="__codelineno-11-49"></a><span class="hll"><span class="w">            </span><span class="p">{</span>
</span><a href="#__codelineno-11-50" id="__codelineno-11-50" name="__codelineno-11-50"></a><span class="hll"><span class="w">                </span><span class="n">Id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Guid</span><span class="p">.</span><span class="n">NewGuid</span><span class="p">(),</span>
</span><a href="#__codelineno-11-51" id="__codelineno-11-51" name="__codelineno-11-51"></a><span class="hll"><span class="w">                </span><span class="n">Name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">product</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
</span><a href="#__codelineno-11-52" id="__codelineno-11-52" name="__codelineno-11-52"></a><span class="hll"><span class="w">                </span><span class="n">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">product</span><span class="p">.</span><span class="n">Description</span><span class="p">,</span>
</span><a href="#__codelineno-11-53" id="__codelineno-11-53" name="__codelineno-11-53"></a><span class="hll"><span class="w">                </span><span class="n">Price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">product</span><span class="p">.</span><span class="n">Price</span><span class="p">,</span>
</span><a href="#__codelineno-11-54" id="__codelineno-11-54" name="__codelineno-11-54"></a><span class="hll"><span class="w">                </span><span class="n">Availability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
</span><a href="#__codelineno-11-55" id="__codelineno-11-55" name="__codelineno-11-55"></a><span class="hll"><span class="w">            </span><span class="p">};</span>
</span><a href="#__codelineno-11-56" id="__codelineno-11-56" name="__codelineno-11-56"></a><span class="hll">
</span><a href="#__codelineno-11-57" id="__codelineno-11-57" name="__codelineno-11-57"></a><span class="hll"><span class="w">            </span><span class="k">await</span><span class="w"> </span><span class="n">_service</span><span class="p">.</span><span class="n">AddProductAsync</span><span class="p">(</span><span class="n">newProduct</span><span class="p">);</span>
</span><a href="#__codelineno-11-58" id="__codelineno-11-58" name="__codelineno-11-58"></a><span class="w">        </span><span class="p">}</span><span class="w">      </span>
<a href="#__codelineno-11-59" id="__codelineno-11-59" name="__codelineno-11-59"></a><span class="w">    </span><span class="p">}</span>
<a href="#__codelineno-11-60" id="__codelineno-11-60" name="__codelineno-11-60"></a><span class="p">}</span>
</code></pre></div> Launch the application and test it with Postman for both get and post.</p> <div class="admonition tip"> <p class="admonition-title">Tip</p> <div class="highlight"><span class="filename">Text Only</span><pre><span></span><code>URI Format for proxy:
fabric/ApplicationName/ServiceName
Eg: fabric:/ECommerce/ProductCatalog
</code></pre></div> </div> <h3 id="end-to-end-flow"><strong>End to End flow</strong><a class="headerlink" href="#end-to-end-flow" title="Permanent link">¬∂</a></h3> <p>Here is end to end flow:<br/> API: Stateless service<br/> ProductsController (Product_API)<br/> ProductCatalog: StatefulService, IProductCatalogService<br/> <pre class="mermaid"><code>sequenceDiagram
    participant ProductsController
    participant ServiceProxyFactory
    participant ProductCatalog
    participant SFProductRepository
    participant IReliableStateManager
        ProductsController-&gt;&gt;ServiceProxyFactory: CreateServiceProxy
        ServiceProxyFactory--&gt;&gt;ProductsController: _service
        ProductsController-&gt;&gt;ProductCatalog :GetAllProductsAsync()
        loop new ServiceReplicaListener of ctx
            ProductCatalog-&gt;&gt;ProductCatalog: new FabricTransportServiceRemotingListener
        end
        ProductCatalog-&gt;&gt;SFProductRepository: GetProducts()
        SFProductRepository-&gt;&gt;IReliableStateManager: products.CreateEnumerableAsync
        SFProductRepository--&gt;&gt;ProductCatalog: result
        ProductCatalog--&gt;&gt;ProductsController: result.ToArray()</code></pre></p> <h2 id="exploring-actor-model-support">Exploring Actor Model Support<a class="headerlink" href="#exploring-actor-model-support" title="Permanent link">¬∂</a></h2> <h2 id="managing-state">Managing State<a class="headerlink" href="#managing-state" title="Permanent link">¬∂</a></h2> <h2 id="getting-ready-for-deployment">Getting Ready for Deployment<a class="headerlink" href="#getting-ready-for-deployment" title="Permanent link">¬∂</a></h2> <h2 id="test">Test<a class="headerlink" href="#test" title="Permanent link">¬∂</a></h2> </article> </div> </div> </main> <footer class="md-footer"> <nav aria-label="Footer" class="md-footer__inner md-grid"> <a aria-label="Previous: Introduction to Azure Service Fabric" class="md-footer__link md-footer__link--prev" href="../azure-service-fabric/" rel="prev"> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg> </div> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> Previous </span> Introduction to Azure Service Fabric </div> </div> </a> <a aria-label="Next: üîó Azure links" class="md-footer__link md-footer__link--next" href="../../azure/links/" rel="next"> <div class="md-footer__title"> <div class="md-ellipsis"> <span class="md-footer__direction"> Next </span> üîó Azure links </div> </div> <div class="md-footer__button md-icon"> <svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class="md-copyright"> Made with <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank"> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class="md-dialog" data-md-component="dialog"> <div class="md-dialog__inner md-typeset"></div> </div> <script id="__config" type="application/json">{"base": "../..", "features": ["search.highlight", "search.suggest", "header.autohide"], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src="../../assets/javascripts/bundle.8492ddcf.min.js"></script> <script src="../../assets/javascripts/extra.js"></script> <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom"});})</script></body> </html>